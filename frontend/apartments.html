<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stanovi - MC73 Generator Uplatnica</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
</head>
<body>
  <button class="mobile-menu-btn" aria-label="Otvori meni" aria-expanded="false">&#9776;</button>

  <div class="page-wrapper">
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
      <div class="sidebar-logo">MC73 Generator</div>

      <ul class="sidebar-nav">
        <li><a href="/index.html"><span class="nav-icon">&#127968;</span> Kontrolna tabla</a></li>
        <li class="admin-only"><a href="/building.html"><span class="nav-icon">&#127970;</span> Zgrada</a></li>
        <li class="admin-only"><a href="/apartments.html" class="active"><span class="nav-icon">&#128209;</span> Stanovi</a></li>
        <li class="admin-only"><a href="/users.html"><span class="nav-icon">&#128101;</span> Korisnici</a></li>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Placanja</div>
        </div>
        <li><a href="/slips.html"><span class="nav-icon">&#128196;</span> Uplatnice</a></li>
        <li><a href="/payments.html"><span class="nav-icon">&#128181;</span> Uplate</a></li>
        <li><a href="/balance.html"><span class="nav-icon">&#128200;</span> Stanje</a></li>
      </ul>

      <div class="sidebar-section">
        <div class="user-info">
          <div class="user-name">-</div>
          <div class="user-email">-</div>
          <div class="user-role"></div>
          <button onclick="logout()" class="btn btn-outline btn-sm mt-1" style="width: 100%;">
            Odjava
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header flex-between">
        <div>
          <h1 class="page-title">Stanovi</h1>
          <p class="page-subtitle">Upravljanje stanovima u zgradi</p>
        </div>
        <button onclick="openApartmentModal()" class="btn btn-primary">
          + Dodaj stan
        </button>
      </div>

      <div class="card">
        <div id="apartments-list">
          <div class="loading">
            <span class="spinner"></span>
            <span>Ucitavanje...</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Apartment Modal -->
  <div id="apartment-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">Dodaj stan</h3>
        <button class="modal-close">&times;</button>
      </div>
      <form id="apartment-form" onsubmit="saveApartment(event)">
        <div class="modal-body">
          <input type="hidden" id="apartment-id">

          <div class="form-row">
            <div class="form-group">
              <label for="apartment_number" class="form-label required">Broj stana</label>
              <input
                type="number"
                id="apartment_number"
                name="apartment_number"
                class="form-control"
                min="1"
                max="99"
                required
              >
            </div>

            <div class="form-group">
              <label for="owner_name" class="form-label required">Ime vlasnika</label>
              <input
                type="text"
                id="owner_name"
                name="owner_name"
                class="form-control"
                required
              >
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="floor_number" class="form-label required">Sprat</label>
              <input
                type="number"
                id="floor_number"
                name="floor_number"
                class="form-control"
                min="-5"
                max="100"
                required
              >
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="override_amount" class="form-label">Poseban iznos (RSD)</label>
              <input
                type="number"
                id="override_amount"
                name="override_amount"
                class="form-control"
                min="0"
                step="0.01"
              >
              <div class="form-text">Ostavite prazno za podrazumevani iznos zgrade</div>
            </div>

            <div class="form-group">
              <label for="user_id" class="form-label">Povezan korisnik</label>
              <select id="user_id" name="user_id" class="form-control form-select">
                <option value="">-- Bez korisnika --</option>
              </select>
            </div>
          </div>

          <div id="apartment-form-error" class="form-error"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" onclick="closeModal('apartment-modal')">Otkazi</button>
          <button type="submit" class="btn btn-primary" id="apartment-save-btn">Sacuvaj</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/app.js"></script>
  <script>
    let apartments = [];
    let users = [];

    async function loadApartments() {
      const initialized = await initPage(true);
      if (!initialized) return;

      try {
        [apartments, users] = await Promise.all([
          api.apartments.list(),
          api.users.list()
        ]);

        renderApartments();
        populateUserSelect();

      } catch (err) {
        console.error('Load apartments error:', err);
        showError(document.getElementById('apartments-list'), 'Greska prilikom ucitavanja stanova');
      }
    }

    function populateUserSelect() {
      const select = document.getElementById('user_id');
      select.innerHTML = '<option value="">-- Bez korisnika --</option>';

      users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = `${user.name} (${user.email})`;
        select.appendChild(option);
      });
    }

    function renderApartments() {
      const container = document.getElementById('apartments-list');

      if (apartments.length === 0) {
        showEmpty(container, 'Nema registrovanih stanova');
        return;
      }

      // Sort by apartment number
      const sorted = [...apartments].sort((a, b) => a.apartment_number - b.apartment_number);

      container.innerHTML = `
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Br.</th>
                <th>Vlasnik</th>
                <th>Sprat</th>
                <th>Iznos</th>
                <th>Korisnik</th>
                <th>Akcije</th>
              </tr>
            </thead>
            <tbody>
              ${sorted.map(apt => {
                const user = users.find(u => u.id === apt.user_id);
                return `
                  <tr>
                    <td><strong>${apt.apartment_number}</strong></td>
                    <td>${escapeHtml(apt.owner_name)}</td>
                    <td>${apt.floor_number}</td>
                    <td>${apt.override_amount ? formatCurrency(apt.override_amount) : '<span class="text-muted">Podrazumevani</span>'}</td>
                    <td>${user ? escapeHtml(user.name) : '<span class="text-muted">-</span>'}</td>
                    <td class="table-actions">
                      <button onclick="editApartment(${apt.id})" class="btn btn-sm btn-outline">Izmeni</button>
                      <button onclick="deleteApartment(${apt.id}, '${escapeHtml(apt.owner_name)}')" class="btn btn-sm btn-danger">Obrisi</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function openApartmentModal(apartment = null) {
      const form = document.getElementById('apartment-form');
      const title = document.getElementById('modal-title');
      const errorEl = document.getElementById('apartment-form-error');

      form.reset();
      errorEl.textContent = '';

      if (apartment) {
        title.textContent = 'Izmeni stan';
        document.getElementById('apartment-id').value = apartment.id;
        document.getElementById('apartment_number').value = apartment.apartment_number;
        document.getElementById('owner_name').value = apartment.owner_name;
        document.getElementById('floor_number').value = apartment.floor_number;
        document.getElementById('override_amount').value = apartment.override_amount || '';
        document.getElementById('user_id').value = apartment.user_id || '';
      } else {
        title.textContent = 'Dodaj stan';
        document.getElementById('apartment-id').value = '';
      }

      openModal('apartment-modal');
    }

    function editApartment(id) {
      const apartment = apartments.find(a => a.id === id);
      if (apartment) {
        openApartmentModal(apartment);
      }
    }

    async function saveApartment(event) {
      event.preventDefault();

      const form = event.target;
      const errorEl = document.getElementById('apartment-form-error');
      const saveBtn = document.getElementById('apartment-save-btn');
      const id = document.getElementById('apartment-id').value;

      errorEl.textContent = '';
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="spinner"></span> Cuvanje...';

      try {
        const data = {
          apartment_number: parseInt(form.apartment_number.value),
          owner_name: form.owner_name.value.trim(),
          floor_number: parseInt(form.floor_number.value),
          override_amount: form.override_amount.value ? parseFloat(form.override_amount.value) : null,
          user_id: form.user_id.value ? parseInt(form.user_id.value) : null
        };

        if (id) {
          await api.apartments.update(id, data);
          showToast('Stan je uspesno azuriran', 'success');
        } else {
          await api.apartments.create(data);
          showToast('Stan je uspesno dodat', 'success');
        }

        closeModal('apartment-modal');
        apartments = await api.apartments.list();
        renderApartments();

      } catch (err) {
        errorEl.textContent = err.message || 'Greska prilikom cuvanja';
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Sacuvaj';
      }
    }

    async function deleteApartment(id, name) {
      if (!confirm(`Da li ste sigurni da zelite da obrisete stan vlasnika "${name}"?\n\nOvo ce obrisati i sve uplatnice i uplate za ovaj stan.`)) {
        return;
      }

      try {
        await api.apartments.delete(id);
        showToast('Stan je uspesno obrisan', 'success');
        apartments = await api.apartments.list();
        renderApartments();
      } catch (err) {
        showToast(err.message || 'Greska prilikom brisanja', 'danger');
      }
    }

    loadApartments();
  </script>
</body>
</html>
