<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zgrada - MC73 Generator Uplatnica</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
</head>
<body>
  <button class="mobile-menu-btn">&#9776;</button>

  <div class="page-wrapper">
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
      <div class="sidebar-logo">MC73 Generator</div>

      <ul class="sidebar-nav">
        <li><a href="/index.html"><span class="nav-icon">&#127968;</span> Kontrolna tabla</a></li>
        <li class="admin-only"><a href="/building.html" class="active"><span class="nav-icon">&#127970;</span> Zgrada</a></li>
        <li class="admin-only"><a href="/apartments.html"><span class="nav-icon">&#128209;</span> Stanovi</a></li>
        <li class="admin-only"><a href="/users.html"><span class="nav-icon">&#128101;</span> Korisnici</a></li>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Placanja</div>
        </div>
        <li><a href="/slips.html"><span class="nav-icon">&#128196;</span> Uplatnice</a></li>
        <li><a href="/payments.html"><span class="nav-icon">&#128181;</span> Uplate</a></li>
        <li><a href="/balance.html"><span class="nav-icon">&#128200;</span> Stanje</a></li>
      </ul>

      <div class="sidebar-section">
        <div class="user-info">
          <div class="user-name">-</div>
          <div class="user-email">-</div>
          <div class="user-role"></div>
          <button onclick="logout()" class="btn btn-outline btn-sm mt-1" style="width: 100%;">
            Odjava
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h1 class="page-title">Podaci o zgradi</h1>
        <p class="page-subtitle">Konfiguracija stambene zajednice</p>
      </div>

      <div class="card">
        <form id="building-form" onsubmit="saveBuilding(event)">
          <div class="form-row">
            <div class="form-group">
              <label for="address" class="form-label required">Adresa</label>
              <input
                type="text"
                id="address"
                name="address"
                class="form-control"
                placeholder="npr. Marka Celebonovica 73"
                required
              >
              <div class="form-text">Ulica i broj</div>
            </div>

            <div class="form-group">
              <label for="city" class="form-label required">Grad</label>
              <input
                type="text"
                id="city"
                name="city"
                class="form-control"
                placeholder="npr. Beograd"
                required
              >
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="bank_account" class="form-label required">Broj racuna</label>
              <input
                type="text"
                id="bank_account"
                name="bank_account"
                class="form-control"
                placeholder="npr. 16054891267"
                required
              >
              <div class="form-text">Uneti kratki format (npr. 16054891267) - automatski se formatira u XXX-XXXXXXXXXXXXX-XX</div>
            </div>

            <div class="form-group">
              <label for="default_amount" class="form-label required">Podrazumevani mesecni iznos (RSD)</label>
              <input
                type="number"
                id="default_amount"
                name="default_amount"
                class="form-control"
                placeholder="npr. 3500"
                min="0.01"
                step="0.01"
                required
              >
              <div class="form-text">Iznos mesecnog odrzavanja za sve stanove (moze se pregaziti za pojedinacne stanove)</div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="recipient_name" class="form-label required">Naziv primaoca</label>
              <input
                type="text"
                id="recipient_name"
                name="recipient_name"
                class="form-control"
                placeholder="npr. Stambena zajednica"
                required
              >
              <div class="form-text">Prefiks za primaoca na uplatnici (npr. "Stambena zajednica" ili "Stamb. zajednica")</div>
            </div>

            <div class="form-group">
              <label for="payment_purpose" class="form-label required">Svrha uplate</label>
              <input
                type="text"
                id="payment_purpose"
                name="payment_purpose"
                class="form-control"
                placeholder="npr. Mesecno odrzavanje zgrade"
                required
              >
              <div class="form-text">Tekst koji se prikazuje u polju "svrha uplate" na uplatnici</div>
            </div>
          </div>

          <div id="form-message"></div>

          <div class="flex-between mt-3">
            <div></div>
            <button type="submit" id="save-btn" class="btn btn-primary">
              Sacuvaj izmene
            </button>
          </div>
        </form>
      </div>
    </main>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/app.js"></script>
  <script>
    async function loadBuilding() {
      const initialized = await initPage(true); // Require admin
      if (!initialized) return;

      // Setup bank account formatting
      setupBankAccountField('bank_account');

      try {
        const building = await api.building.get();

        document.getElementById('address').value = building.address || '';
        document.getElementById('city').value = building.city || '';
        document.getElementById('bank_account').value = building.bank_account || '';
        document.getElementById('default_amount').value = building.default_amount || '';
        document.getElementById('recipient_name').value = building.recipient_name || 'Stambena zajednica';
        document.getElementById('payment_purpose').value = building.payment_purpose || 'Mesecno odrzavanje zgrade';

      } catch (err) {
        console.error('Load building error:', err);
        // Building might not exist yet, form will be empty
      }
    }

    async function saveBuilding(event) {
      event.preventDefault();

      const form = event.target;
      const messageEl = document.getElementById('form-message');
      const saveBtn = document.getElementById('save-btn');

      // Clear previous message
      messageEl.innerHTML = '';

      // Disable button
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="spinner"></span> Cuvanje...';

      try {
        const data = {
          address: form.address.value.trim(),
          city: form.city.value.trim(),
          bank_account: form.bank_account.value.trim(),
          default_amount: parseFloat(form.default_amount.value),
          recipient_name: form.recipient_name.value.trim(),
          payment_purpose: form.payment_purpose.value.trim()
        };

        const building = await api.building.update(data);

        // Update form with returned values (formatted bank account)
        form.bank_account.value = building.bank_account;

        showSuccess(messageEl, 'Podaci o zgradi su uspesno sacuvani');
        showToast('Podaci sacuvani', 'success');

      } catch (err) {
        showError(messageEl, err.message || 'Greska prilikom cuvanja');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Sacuvaj izmene';
      }
    }

    loadBuilding();
  </script>
</body>
</html>
