<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kontrolna tabla - MC73 Generator Uplatnica</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
</head>
<body>
  <button class="mobile-menu-btn">&#9776;</button>

  <div class="page-wrapper">
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
      <div class="sidebar-logo">MC73 Generator</div>

      <ul class="sidebar-nav">
        <li><a href="/index.html" class="active"><span class="nav-icon">&#127968;</span> Kontrolna tabla</a></li>
        <li class="admin-only"><a href="/building.html"><span class="nav-icon">&#127970;</span> Zgrada</a></li>
        <li class="admin-only"><a href="/apartments.html"><span class="nav-icon">&#128209;</span> Stanovi</a></li>
        <li class="admin-only"><a href="/users.html"><span class="nav-icon">&#128101;</span> Korisnici</a></li>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Placanja</div>
        </div>
        <li><a href="/slips.html"><span class="nav-icon">&#128196;</span> Uplatnice</a></li>
        <li><a href="/payments.html"><span class="nav-icon">&#128181;</span> Uplate</a></li>
        <li><a href="/balance.html"><span class="nav-icon">&#128200;</span> Stanje</a></li>
      </ul>

      <div class="sidebar-section">
        <div class="user-info">
          <div class="user-name">-</div>
          <div class="user-email">-</div>
          <div class="user-role"></div>
          <button onclick="logout()" class="btn btn-outline btn-sm mt-1" style="width: 100%;">
            Odjava
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h1 class="page-title">Kontrolna tabla</h1>
        <p class="page-subtitle">Pregled i upravljanje stambenom zajednicom</p>
      </div>

      <!-- Admin Dashboard -->
      <div id="admin-dashboard" class="admin-only">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Ukupno stanova</div>
            <div class="stat-value" id="stat-apartments">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ukupno korisnika</div>
            <div class="stat-value" id="stat-users">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Mesecni iznos</div>
            <div class="stat-value" id="stat-amount">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ukupno stanje</div>
            <div class="stat-value" id="stat-balance">-</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Brze akcije</h2>
          </div>
          <div class="d-flex gap-2" style="flex-wrap: wrap;">
            <a href="/slips.html" class="btn btn-primary">Generisi uplatnice</a>
            <a href="/payments.html" class="btn btn-success">Evidentiraj uplatu</a>
            <a href="/apartments.html" class="btn btn-secondary">Upravljaj stanovima</a>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Stanovi sa negativnim stanjem</h2>
          </div>
          <div id="negative-balances">
            <div class="loading">
              <span class="spinner"></span>
              <span>Ucitavanje...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- User Dashboard -->
      <div id="user-dashboard" class="user-only" style="display: none;">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Vas stan</div>
            <div class="stat-value" id="user-apartment">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Trenutno stanje</div>
            <div class="stat-value" id="user-balance">-</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Poslednje uplate</h2>
          </div>
          <div id="user-payments">
            <div class="loading">
              <span class="spinner"></span>
              <span>Ucitavanje...</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/app.js"></script>
  <script>
    async function loadDashboard() {
      const initialized = await initPage();
      if (!initialized) return;

      const user = getCurrentUser();

      if (user.is_admin) {
        // Show admin dashboard
        document.getElementById('admin-dashboard').style.display = '';
        document.getElementById('user-dashboard').style.display = 'none';
        await loadAdminDashboard();
      } else {
        // Show user dashboard
        document.getElementById('admin-dashboard').style.display = 'none';
        document.getElementById('user-dashboard').style.display = '';
        await loadUserDashboard();
      }
    }

    async function loadAdminDashboard() {
      try {
        // Load stats
        const [apartments, users, building, balances] = await Promise.all([
          api.apartments.list(),
          api.users.list(),
          api.building.get(),
          api.payments.getAllBalances()
        ]);

        document.getElementById('stat-apartments').textContent = apartments.length;
        document.getElementById('stat-users').textContent = users.length;
        document.getElementById('stat-amount').textContent = formatCurrency(building.default_amount);

        // Calculate total balance
        const totalBalance = balances.reduce((sum, b) => sum + b.balance, 0);
        const balanceEl = document.getElementById('stat-balance');
        balanceEl.textContent = formatCurrency(totalBalance);
        balanceEl.className = 'stat-value ' + (totalBalance >= 0 ? 'positive' : 'negative');

        // Show negative balances
        const negativeBalances = balances.filter(b => b.balance < 0);
        const container = document.getElementById('negative-balances');

        if (negativeBalances.length === 0) {
          showEmpty(container, 'Svi stanovi imaju pozitivno ili nulto stanje');
        } else {
          container.innerHTML = `
            <div class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    <th>Stan</th>
                    <th>Vlasnik</th>
                    <th>Stanje</th>
                  </tr>
                </thead>
                <tbody>
                  ${negativeBalances.map(b => `
                    <tr>
                      <td>${b.apartment_number}</td>
                      <td>${escapeHtml(b.owner_name)}</td>
                      <td class="text-danger">${formatCurrency(b.balance)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }

      } catch (err) {
        console.error('Load admin dashboard error:', err);
        showToast('Greska prilikom ucitavanja podataka', 'danger');
      }
    }

    async function loadUserDashboard() {
      try {
        const apartments = await api.apartments.list();

        if (apartments.length === 0) {
          document.getElementById('user-apartment').textContent = 'Nije dodeljen';
          document.getElementById('user-balance').textContent = '-';
          showEmpty(document.getElementById('user-payments'), 'Nemate dodeljen stan');
          return;
        }

        const apartment = apartments[0];
        document.getElementById('user-apartment').textContent = `Stan ${apartment.apartment_number}`;

        // Load balance and payments
        const [balanceData, payments] = await Promise.all([
          api.payments.getBalance(apartment.id),
          api.payments.list()
        ]);

        const balanceEl = document.getElementById('user-balance');
        balanceEl.textContent = formatCurrency(balanceData.balance);
        balanceEl.className = 'stat-value ' + (balanceData.balance >= 0 ? 'positive' : 'negative');

        // Show recent payments
        const container = document.getElementById('user-payments');
        if (payments.length === 0) {
          showEmpty(container, 'Nema evidentiranih uplata');
        } else {
          const recentPayments = payments.slice(0, 5);
          container.innerHTML = `
            <div class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    <th>Datum</th>
                    <th>Iznos</th>
                    <th>Napomena</th>
                  </tr>
                </thead>
                <tbody>
                  ${recentPayments.map(p => `
                    <tr>
                      <td>${formatDate(p.payment_date)}</td>
                      <td class="text-success">${formatCurrency(p.amount)}</td>
                      <td>${escapeHtml(p.notes || '-')}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }

      } catch (err) {
        console.error('Load user dashboard error:', err);
        showToast('Greska prilikom ucitavanja podataka', 'danger');
      }
    }

    loadDashboard();
  </script>
</body>
</html>
