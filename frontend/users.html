<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Korisnici - MC73 Generator Uplatnica</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <button class="mobile-menu-btn">&#9776;</button>

  <div class="page-wrapper">
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
      <div class="sidebar-logo">MC73 Generator</div>

      <ul class="sidebar-nav">
        <li><a href="/index.html"><span class="nav-icon">&#127968;</span> Kontrolna tabla</a></li>
        <li class="admin-only"><a href="/building.html"><span class="nav-icon">&#127970;</span> Zgrada</a></li>
        <li class="admin-only"><a href="/apartments.html"><span class="nav-icon">&#128209;</span> Stanovi</a></li>
        <li class="admin-only"><a href="/users.html" class="active"><span class="nav-icon">&#128101;</span> Korisnici</a></li>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Placanja</div>
        </div>
        <li><a href="/slips.html"><span class="nav-icon">&#128196;</span> Uplatnice</a></li>
        <li><a href="/payments.html"><span class="nav-icon">&#128181;</span> Uplate</a></li>
        <li><a href="/balance.html"><span class="nav-icon">&#128200;</span> Stanje</a></li>
      </ul>

      <div class="sidebar-section">
        <div class="user-info">
          <div class="user-name">-</div>
          <div class="user-email">-</div>
          <div class="user-role"></div>
          <button onclick="logout()" class="btn btn-outline btn-sm mt-1" style="width: 100%;">
            Odjava
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header flex-between">
        <div>
          <h1 class="page-title">Korisnici</h1>
          <p class="page-subtitle">Upravljanje korisnickim nalozima</p>
        </div>
        <button onclick="openUserModal()" class="btn btn-primary">
          + Dodaj korisnika
        </button>
      </div>

      <div class="card">
        <div id="users-list">
          <div class="loading">
            <span class="spinner"></span>
            <span>Ucitavanje...</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- User Modal -->
  <div id="user-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">Dodaj korisnika</h3>
        <button class="modal-close">&times;</button>
      </div>
      <form id="user-form" onsubmit="saveUser(event)">
        <div class="modal-body">
          <input type="hidden" id="user-id">

          <div class="form-group">
            <label for="name" class="form-label required">Ime i prezime</label>
            <input
              type="text"
              id="name"
              name="name"
              class="form-control"
              required
            >
          </div>

          <div class="form-group">
            <label for="email" class="form-label required">Email adresa</label>
            <input
              type="email"
              id="email"
              name="email"
              class="form-control"
              required
            >
          </div>

          <div class="form-group" id="password-group">
            <label for="password" class="form-label" id="password-label">Lozinka</label>
            <input
              type="password"
              id="password"
              name="password"
              class="form-control"
            >
            <div class="form-text" id="password-help">Min 8 karaktera, jedno veliko slovo, jedno malo slovo, jedan broj</div>
          </div>

          <div class="form-group">
            <label class="form-label">Uloge</label>
            <div class="form-check">
              <input type="checkbox" id="is_admin" name="is_admin" class="form-check-input">
              <label for="is_admin" class="form-check-label">Administrator</label>
            </div>
            <div class="form-check">
              <input type="checkbox" id="is_user" name="is_user" class="form-check-input" checked>
              <label for="is_user" class="form-check-label">Korisnik</label>
            </div>
          </div>

          <div id="user-form-error" class="form-error"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" onclick="closeModal('user-modal')">Otkazi</button>
          <button type="submit" class="btn btn-primary" id="user-save-btn">Sacuvaj</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/app.js"></script>
  <script>
    let users = [];

    async function loadUsers() {
      const initialized = await initPage(true);
      if (!initialized) return;

      try {
        users = await api.users.list();
        renderUsers();
      } catch (err) {
        console.error('Load users error:', err);
        showError(document.getElementById('users-list'), 'Greska prilikom ucitavanja korisnika');
      }
    }

    function renderUsers() {
      const container = document.getElementById('users-list');
      const currentUser = getCurrentUser();

      if (users.length === 0) {
        showEmpty(container, 'Nema registrovanih korisnika');
        return;
      }

      container.innerHTML = `
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Ime</th>
                <th>Email</th>
                <th>Uloge</th>
                <th>Kreiran</th>
                <th>Akcije</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(user => {
                const roles = [];
                if (user.is_admin) roles.push('<span class="badge badge-warning">Admin</span>');
                if (user.is_user) roles.push('<span class="badge badge-info">Korisnik</span>');

                const isSelf = user.id === currentUser.id;

                return `
                  <tr>
                    <td>${escapeHtml(user.name)} ${isSelf ? '<span class="text-muted">(vi)</span>' : ''}</td>
                    <td>${escapeHtml(user.email)}</td>
                    <td>${roles.join(' ')}</td>
                    <td>${formatDate(user.created_at)}</td>
                    <td class="table-actions">
                      <button onclick="editUser(${user.id})" class="btn btn-sm btn-outline">Izmeni</button>
                      ${!isSelf ? `<button onclick="deleteUser(${user.id}, '${escapeHtml(user.name)}')" class="btn btn-sm btn-danger">Obrisi</button>` : ''}
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function openUserModal(user = null) {
      const form = document.getElementById('user-form');
      const title = document.getElementById('modal-title');
      const errorEl = document.getElementById('user-form-error');
      const passwordLabel = document.getElementById('password-label');
      const passwordHelp = document.getElementById('password-help');

      form.reset();
      errorEl.textContent = '';

      if (user) {
        title.textContent = 'Izmeni korisnika';
        document.getElementById('user-id').value = user.id;
        document.getElementById('name').value = user.name;
        document.getElementById('email').value = user.email;
        document.getElementById('is_admin').checked = user.is_admin;
        document.getElementById('is_user').checked = user.is_user;

        // Password is optional when editing
        passwordLabel.classList.remove('required');
        passwordHelp.textContent = 'Ostavite prazno da zadrzite postojecu lozinku';
      } else {
        title.textContent = 'Dodaj korisnika';
        document.getElementById('user-id').value = '';
        document.getElementById('is_user').checked = true;

        // Password is required for new users
        passwordLabel.classList.add('required');
        passwordHelp.textContent = 'Min 8 karaktera, jedno veliko slovo, jedno malo slovo, jedan broj';
      }

      openModal('user-modal');
    }

    function editUser(id) {
      const user = users.find(u => u.id === id);
      if (user) {
        openUserModal(user);
      }
    }

    async function saveUser(event) {
      event.preventDefault();

      const form = event.target;
      const errorEl = document.getElementById('user-form-error');
      const saveBtn = document.getElementById('user-save-btn');
      const id = document.getElementById('user-id').value;

      errorEl.textContent = '';
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="spinner"></span> Cuvanje...';

      try {
        const data = {
          name: form.name.value.trim(),
          email: form.email.value.trim(),
          is_admin: form.is_admin.checked,
          is_user: form.is_user.checked
        };

        // Add password only if provided
        if (form.password.value) {
          data.password = form.password.value;
        } else if (!id) {
          // Password required for new users
          throw new Error('Lozinka je obavezna za novog korisnika');
        }

        if (id) {
          await api.users.update(id, data);
          showToast('Korisnik je uspesno azuriran', 'success');
        } else {
          await api.users.create(data);
          showToast('Korisnik je uspesno dodat', 'success');
        }

        closeModal('user-modal');
        users = await api.users.list();
        renderUsers();

      } catch (err) {
        errorEl.textContent = err.message || 'Greska prilikom cuvanja';
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Sacuvaj';
      }
    }

    async function deleteUser(id, name) {
      if (!confirm(`Da li ste sigurni da zelite da obrisete korisnika "${name}"?`)) {
        return;
      }

      try {
        await api.users.delete(id);
        showToast('Korisnik je uspesno obrisan', 'success');
        users = await api.users.list();
        renderUsers();
      } catch (err) {
        showToast(err.message || 'Greska prilikom brisanja', 'danger');
      }
    }

    loadUsers();
  </script>
</body>
</html>
